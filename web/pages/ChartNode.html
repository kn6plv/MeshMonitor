<canvas id="{{id}}"></canvas>
<script>
(function(){
  const chart = new Chart(document.getElementById('{{id}}'), {
    type: 'scatter',
    data: {
      labels: [],
      datasets: [{
        backgroundColor: 'red',
        borderWidth: 0,
        data: [
          {{#each data}}
          { x:{{x}},y:{{y}} },
          {{/each}}
        ],
        pointBackgroundColor: [
          {{#each color}}
          '{{this}}',
          {{/each}}
        ]
      }]
    },
    options: {
      clip: 20,
      maintainAspectRatio: false,
      scales: {
        x: {
          type: 'time',
          title: {
            display: true,
            text: '{{date}}'
          }
        },
        y: {
          title: {
            display: true,
            text: 'Sequence Nr',
          },
          min: 0,
          max: 65535
        }
      },
      plugins: {
        legend: {
          display: false
        }
      }
    }
  });
  let cursor = {{cursor}};
  let live = {{live}};
  onMessage['chart.update.response.{{id}}'] = msg => {
    const ndata = msg.value.data;
    const ncolor = msg.value.color;
    const data = chart.data.datasets[0].data;
    const color = chart.data.datasets[0].pointBackgroundColor;
    if (msg.value.update) {
      data.splice(0, ndata.length);
      color.splice(0, ndata.length);
    }
    else {
      data.length = 0;
      color.length = 0;
    }
    data.push(...ndata);
    color.push(...ncolor);
    chart.options.scales.x.title.text = msg.value.date;
    chart.update();
    cursor = msg.value.cursor;
    live = msg.value.live;
  }
  whenVisible('info', {{step}}, () => {
    if (live) {
      send('chart.update.request', { id: '{{id}}', cursor });
    }
  });
})();
</script>
