<div class="per-node">
  <div class="chart-nodes">
    <canvas id="{{id}}"></canvas>
    <script>
    (function(){
      const chart = new Chart(document.getElementById('{{id}}'), {
        type: 'bar',
        data: {
          labels: [
            {{#each labels}}
              '{{this}}',
            {{/each}}
          ],
          datasets: [
            {{#each datasets}}
              {
                label: '{{label}}',
                data: [ {{data}} ],
                {{#if (eq label 'Out Of Order')}}
                backgroundColor: 'red',
                {{else if (eq label 'Duplicate')}}
                backgroundColor: 'blue',
                {{else}}
                backgroundColor: 'green',
                {{/if}}
              },
            {{/each}}
          ]
        },
        options: {
          maintainAspectRatio: false,
          scales: {
            x: {
              stacked: true,
              title: {
                display: true,
                text: '{{date}}'
              },
              ticks: {
                font: { size: 10 }
              }
            },
            y: {
              stacked: true,
              title: {
                display: true,
                text: 'Messages Per Second'
              }
            }
          },
          onClick: (event, info, chart) => send('chart.node.select', { id: '{{id}}', idx: info[0].index })
        }
      });
      let live = {{live}};
      onMessage['chart.position.update.{{id}}'] = msg => {
        chart.data.labels = msg.value.labels;
        const datasets = chart.data.datasets;
        const ndatasets = msg.value.datasets;
        let eq = true;
        for (let i = 0; eq && i < datasets.length; i++) {
          if (datasets[i].data.length !== ndatasets[i].data.length) {
            eq = false;
          }
        }
        if (eq) {
          for (let i = 0; i < datasets.length; i++) {
            for (let j = 0; j < datasets[i].data.length; j++) {
              datasets[i].data[j] = ndatasets[i].data[j];
            }
          }
        }
        else {
          for (let i = 0; i < datasets.length; i++) {
            datasets[i].data.length = 0;
          }
          chart.update();
          for (let i = 0; i < datasets.length; i++) {
            datasets[i].data.push(...ndatasets[i].data);
          }
        }
        chart.options.scales.x.title.text = msg.value.date;
        chart.update();
        live = msg.value.live;
      }
      whenVisible('info', 10, () => {
        if (live) {
          send('chart.update.request', { id: '{{id}}', position: 1007 });
        }
      });
    })();
    </script>
  </div>
  <div id="scrub_{{id}}" class="chart-nodes-scrub" tabindex="0">
    <input type="range" min="0" max="1007" value="1007" step="1">
  </div>
  <script>
    function notify() {
      send('chart.position.change', { id: '{{id}}', position: parseInt(document.querySelector("#scrub_{{id}} input").value) })
    }
    document.querySelector("#scrub_{{id}}").addEventListener('keydown', event => {
      if (event.key == 'ArrowRight') {
        event.target.firstElementChild.stepUp();
        notify();
      }
      else if (event.key === 'ArrowLeft') {
        event.target.firstElementChild.stepDown();
        notify();
      }
    });
    document.querySelector("#scrub_{{id}} input").addEventListener('change', notify);
  </script>
</div>
